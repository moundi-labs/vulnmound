# CVE-2025-55199 JSON Schema Circular Reference Attack Test
# Makefile for testing vulnerable and mitigation versions

.PHONY: all build-vulnerable build-mitigation test-vulnerable test-mitigation clean help

# Default target
all: build-vulnerable build-mitigation test-vulnerable test-mitigation

# Build vulnerable Docker image
build-vulnerable:
	@echo "Building vulnerable Docker image..."
	cd vulnerable && docker build -t cve-2025-55199-vulnerable .
	@echo "✓ Vulnerable image built successfully"

# Build mitigation Docker image
build-mitigation:
	@echo "Building mitigation Docker image..."
	cd mitigation && docker build -t cve-2025-55199-mitigation .
	@echo "✓ Mitigation image built successfully"

# Test vulnerable version with attack scenarios
test-vulnerable:
	@echo "Testing vulnerable version with attack scenarios..."
	@echo "================================================"
	
	@echo "Test 1: /dev/zero attack (should hang/timeout)"
	@docker run --rm --stop-timeout=10 cve-2025-55199-vulnerable '{"type":"string","pattern":"^.*$$","$$ref":"file:///dev/zero"}' || echo "✓ Attack succeeded (timeout expected)"
	
	@echo ""
	@echo "Test 2: /dev/random attack (should hang/timeout)"
	@docker run --rm --stop-timeout=10 cve-2025-55199-vulnerable '{"type":"string","pattern":"^.*$$","$$ref":"file:///dev/random"}' || echo "✓ Attack succeeded (timeout expected)"
	
	@echo ""
	@echo "Test 3: Circular reference attack (should hang/timeout)"
	@docker run --rm --stop-timeout=10 cve-2025-55199-vulnerable '{"type":"object","properties":{"a":{"$$ref":"#/properties/b"},"b":{"$$ref":"#/properties/c"},"c":{"$$ref":"#/properties/a"}}}' || echo "✓ Attack succeeded (timeout expected)"
	
	@echo ""
	@echo "Test 4: Safe schema (should work)"
	@docker run --rm cve-2025-55199-vulnerable '{"type":"object","properties":{"name":{"type":"string"},"age":{"type":"number"}}}' && echo "✓ Safe schema worked"

# Test mitigation version with attack scenarios
test-mitigation:
	@echo "Testing mitigation version with attack scenarios..."
	@echo "=================================================="
	
	@echo "Test 1: /dev/zero attack (should be blocked)"
	@docker run --rm cve-2025-55199-mitigation '{"type":"string","pattern":"^.*$$","$$ref":"file:///dev/zero"}' && echo "✓ Attack blocked successfully"
	
	@echo ""
	@echo "Test 2: /dev/random attack (should be blocked)"
	@docker run --rm cve-2025-55199-mitigation '{"type":"string","pattern":"^.*$$","$$ref":"file:///dev/random"}' && echo "✓ Attack blocked successfully"
	
	@echo ""
	@echo "Test 3: Circular reference attack (should be blocked)"
	@docker run --rm cve-2025-55199-mitigation '{"type":"object","properties":{"a":{"$$ref":"#/properties/b"},"b":{"$$ref":"#/properties/c"},"c":{"$$ref":"#/properties/a"}}}' && echo "✓ Attack blocked successfully"
	
	@echo ""
	@echo "Test 4: Safe schema (should work)"
	@docker run --rm cve-2025-55199-mitigation '{"type":"object","properties":{"name":{"type":"string"},"age":{"type":"number"}}}' && echo "✓ Safe schema worked"

# Clean up Docker images
clean:
	@echo "Cleaning up Docker images..."
	docker rmi cve-2025-55199-vulnerable 2>/dev/null || true
	docker rmi cve-2025-55199-mitigation 2>/dev/null || true
	@echo "✓ Cleanup completed"

# Show help
help:
	@echo "CVE-2025-55199 JSON Schema Circular Reference Attack Test"
	@echo "========================================================"
	@echo ""
	@echo "Available targets:"
	@echo "  build-vulnerable  - Build vulnerable Docker image"
	@echo "  build-mitigation  - Build mitigation Docker image"
	@echo "  test-vulnerable   - Test vulnerable version with attacks"
	@echo "  test-mitigation   - Test mitigation version with attacks"
	@echo "  all              - Build and test both versions"
	@echo "  clean            - Remove Docker images"
	@echo "  help             - Show this help message"
	@echo ""
	@echo "Examples:"
	@echo "  make all                    # Build and test everything"
	@echo "  make test-vulnerable        # Test only vulnerable version"
	@echo "  make test-mitigation        # Test only mitigation version"
